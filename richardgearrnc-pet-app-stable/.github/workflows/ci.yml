name: Flutter CI

on:
  pull_request:
  push:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default: read-only
permissions:
  contents: read

env:
  FLUTTER_VERSION: "3.38.6"

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # ANALYZE & TEST
  # Runs on all branches and pull requests
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  analyze-test:
    name: Analyze & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify pubspec.lock consistency
        run: git diff --exit-code pubspec.lock

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Verify generated files are committed
        run: |
          git diff --exit-code lib/ || (
            echo "::error::Generated files are out of date. Run 'dart run build_runner build' and commit the changes."
            exit 1
          )

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Run analyzer (strict)
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # BUILD RELEASE APK (main branch only)
  # Builds release APK and publishes as GitHub Release
  #
  # ‚ö†Ô∏è VERSION CONTROL PHILOSOPHY:
  #
  # Why we DON'T auto-bump versions in CI:
  # 1. Versioning decisions are INTENT, not mechanics
  # 2. Semantic versioning (major.minor.patch) has human meaning
  # 3. CI should ENFORCE policy, not MAKE policy
  # 4. Manual bumps prevent version conflicts in PRs
  # 5. Clear git history shows who intended what release
  #
  # Instead: Developers manually update pubspec.yaml, CI validates & deploys
  #
  # ‚úÖ Version format: X.Y.Z+N (e.g., 1.0.0+1)
  #    - X.Y.Z = semantic version (humans control this)
  #    - +N = build number (optional, for build tracking)
  #
  # ‚ùå CI GUARDRAILS prevent common mistakes:
  #    - Prevents -dev versions from shipping to main
  #    - Validates CHANGELOG.md is updated
  #    - Enforces version consistency across files
  #
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: analyze-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: dart run build_runner build --delete-conflicting-outputs

      - name: Extract project metadata
        id: meta
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '[:space:]')
          NAME=$(grep '^name:' pubspec.yaml | sed 's/name: //' | tr -d '[:space:]' | tr '_' '-')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Validate release version
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          if [[ "$VERSION" == *"-dev"* ]]; then
            echo "::error::‚ùå Cannot publish dev version '$VERSION' to main branch"
            echo "::error::Dev versions can only be published to dev branch"
            echo "::error::Update pubspec.yaml to remove '-dev' suffix before merging to main"
            exit 1
          fi
          echo "‚úÖ Version validation passed: $VERSION"

      - name: Build Release APKs (split per ABI)
        run: flutter build apk --release --split-per-abi

      - name: Rename APKs
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          NAME="${{ steps.meta.outputs.name }}"
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk "${NAME}-v${VERSION}-arm64-v8a.apk"
          mv app-armeabi-v7a-release.apk "${NAME}-v${VERSION}-armeabi-v7a.apk"
          mv app-x86_64-release.apk "${NAME}-v${VERSION}-x86_64.apk"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: build/app/outputs/flutter-apk/${{ steps.meta.outputs.name }}-*.apk

      - name: Read changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          # Extract changelog section for this version
          CHANGELOG=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d')
          # Handle multiline output
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "content=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.meta.outputs.version }}
          name: Release v${{ steps.meta.outputs.version }}
          body: |
            ## üöÄ Release v${{ steps.meta.outputs.version }}

            ### What's New
            ${{ steps.changelog.outputs.content }}

            ### Downloads
            Choose the APK that matches your device architecture:

            | APK | Architecture | Devices |
            |-----|--------------|--------|
            | `arm64-v8a` | 64-bit ARM | Most modern Android phones (2017+) |
            | `armeabi-v7a` | 32-bit ARM | Older Android phones |
            | `x86_64` | 64-bit x86 | Android emulators, Chromebooks |

            ### Installation
            ```bash
            # For most modern devices (64-bit ARM)
            adb install ${{ steps.meta.outputs.name }}-v${{ steps.meta.outputs.version }}-arm64-v8a.apk
            ```

            ---
            **View full changelog**: [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: build/app/outputs/flutter-apk/${{ steps.meta.outputs.name }}-*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # BUILD DEBUG APK (dev branch only)
  # Builds debug APK and publishes as GitHub Pre-release
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: analyze-test
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - run: flutter pub get
      - run: dart run build_runner build --delete-conflicting-outputs

      - name: Extract project metadata
        id: meta
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '[:space:]')
          NAME=$(grep '^name:' pubspec.yaml | sed 's/name: //' | tr -d '[:space:]' | tr '_' '-')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Generate build metadata
        id: build
        run: |
          echo "number=$(date +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build Debug APKs (split per ABI)
        run: flutter build apk --debug --split-per-abi

      - name: Rename APKs
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          NAME="${{ steps.meta.outputs.name }}"
          BUILD="${{ steps.build.outputs.number }}"
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-debug.apk "${NAME}-v${VERSION}-dev.${BUILD}-arm64-v8a.apk"
          mv app-armeabi-v7a-debug.apk "${NAME}-v${VERSION}-dev.${BUILD}-armeabi-v7a.apk"
          mv app-x86_64-debug.apk "${NAME}-v${VERSION}-dev.${BUILD}-x86_64.apk"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-apks
          path: build/app/outputs/flutter-apk/${{ steps.meta.outputs.name }}-*.apk

      - name: Create GitHub Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.meta.outputs.version }}-dev.${{ steps.build.outputs.number }}
          name: Pre-release v${{ steps.meta.outputs.version }}-dev.${{ steps.build.outputs.number }}
          body: |
            ## üß™ Pre-release v${{ steps.meta.outputs.version }}-dev.${{ steps.build.outputs.number }}

            > ‚ö†Ô∏è **This is a development build for testing purposes only.**

            ### Build Info
            - **Branch**: `dev`
            - **Commit**: `${{ steps.build.outputs.sha }}`
            - **Build Timestamp**: `${{ steps.build.outputs.number }}`

            ### Downloads
            Choose the APK that matches your device architecture:

            | APK | Architecture | Devices |
            |-----|--------------|--------|
            | `arm64-v8a` | 64-bit ARM | Most modern Android phones (2017+) |
            | `armeabi-v7a` | 32-bit ARM | Older Android phones |
            | `x86_64` | 64-bit x86 | Android emulators, Chromebooks |

            ### ‚ö° Testing Notes
            - This build contains the latest features from the `dev` branch
            - Use this for testing before release
            - Report issues on [GitHub Issues](https://github.com/${{ github.repository }}/issues)

            ---
            **Note**: This build may contain experimental features and should not be used in production.
          files: build/app/outputs/flutter-apk/${{ steps.meta.outputs.name }}-*.apk
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
